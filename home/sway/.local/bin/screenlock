#!/usr/bin/bash
DIR="${XDG_CACHE_HOME}/screenlock"
GRIM=/usr/sbin/grim
CONVERT=/usr/sbin/convert
SWAYLOCK=/usr/sbin/swaylock

if [ ! -d "${DIR}"  ]; then
  mkdir -p "${DIR}"
fi

OUTPUTS=$(swaymsg -t get_outputs -p | awk '/Output/ { print $2 }')

PREV_IFS=$IFS
IFS=$'\n'
OUTPUTS=($OUTPUTS)
IFS=$PREV_IFS

for output in "${OUTPUTS[@]}"; do
  $GRIM -o "${output}" "${DIR}/${output}.jpg"
  $CONVERT "${DIR}/${output}.jpg" -blur 0x5 "${DIR}/${output}.jpg"
done

echo $(wc -l <<< "${OUTPUTS[@]}")

LOCKS=$(
  awk -v DIR=${DIR} \
      '{ print "-i "$0 ":" DIR "/" $0 ".jpg " }' \
      <<< $(printf "%s\n" "${OUTPUTS[@]}")
)

$SWAYLOCK $( IFS=$'\n'; echo "${LOCKS[*]}")
